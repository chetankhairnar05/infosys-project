<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Park Ease Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .fade-in {
        animation: fadeIn 0.2s ease-in-out;
      }
      .slide-in {
        animation: slideIn 0.2s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateX(10px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Hide Scrollbar but keep functionality */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 h-screen flex justify-center overflow-hidden"
  >
    <!-- MOBILE CONTAINER (Simulates a phone screen on desktop) -->
    <div
      class="w-full max-w-md bg-white h-full flex flex-col shadow-2xl relative"
    >
      <!-- ================= NAVIGATION HEADER ================= -->
      <header
        id="app-header"
        class="bg-white border-b border-gray-100 px-4 py-3 flex justify-between items-center z-20 hidden"
      >
        <!-- Left: Back Button or Logo -->
        <div class="flex items-center w-1/3">
          <button
            id="btn-back"
            onclick="goBack()"
            class="hidden p-2 -ml-2 text-gray-600 hover:bg-gray-50 rounded-full transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <div
            id="header-logo"
            class="flex items-center text-indigo-700 font-bold text-lg tracking-tight"
          >
            <svg
              class="w-6 h-6 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            ParkEase
          </div>
        </div>

        <!-- Center: Vehicle Selector (Only on Home) -->
        <div
          id="header-vehicle-select"
          class="w-1/3 flex justify-center hidden"
        >
          <div class="relative">
            <select
              id="global-vehicle-select"
              onchange="switchVehicle(this.value)"
              class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-xs font-semibold py-1.5 pl-3 pr-8 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              <!-- Populated by JS -->
            </select>
            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"
            >
              <svg
                class="h-3 w-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Right: Profile -->
        <div class="w-1/3 flex justify-end">
          <button
            onclick="navigate('view-profile')"
            class="p-1 rounded-full border border-gray-200 hover:bg-gray-50"
          >
            <img
              id="header-avatar"
              src="https://api.dicebear.com/7.x/avataaars/svg?seed=User"
              class="w-7 h-7 rounded-full"
            />
          </button>
        </div>
      </header>

      <!-- ================= MAIN CONTENT SCROLL AREA ================= -->
      <main
        id="main-content"
        class="flex-1 overflow-y-auto bg-gray-50 relative no-scrollbar"
      >
        <!-- 1. AUTH SCREEN -->
        <section
          id="view-auth"
          class="min-h-full flex flex-col justify-center p-8 bg-white fade-in"
        >
          <div class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">
              Park Ease
            </h1>
            <p class="text-gray-500">Stop circling. Start parking.</p>
          </div>

          <div class="space-y-4">
            <button
              onclick="handleAuth('google')"
              class="w-full flex items-center justify-center border border-gray-300 bg-white py-3.5 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition"
            >
              <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                <path
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                  fill="#4285F4"
                />
                <path
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                  fill="#34A853"
                />
                <path
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26c.46-1.42 1.8-2.58 3.51-2.58z"
                  fill="#FBBC05"
                />
                <path
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                  fill="#EA4335"
                />
              </svg>
              Continue with Google
            </button>

            <div class="relative py-2">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-200"></div>
              </div>
              <div class="relative flex justify-center text-xs">
                <span class="px-2 bg-white text-gray-400">OR</span>
              </div>
            </div>

            <form onsubmit="handleAuth('email', event)" class="space-y-4">
              <input
                type="email"
                placeholder="Email Address"
                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
              />
              <input
                type="password"
                placeholder="Password"
                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition"
              />
              <button
                type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition"
              >
                Login
              </button>
            </form>
          </div>
          <p class="text-center text-xs text-gray-400 mt-8">
            By continuing, you agree to our Terms of Service.
          </p>
        </section>

        <!-- 2. HOME SCREEN (LOT LIST) -->
        <section id="view-home" class="hidden pb-20 fade-in">
          <div class="p-4">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Nearby Parking</h2>

            <!-- Search Bar -->
            <div class="relative mb-6">
              <input
                type="text"
                placeholder="Search location..."
                class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl shadow-sm text-sm focus:outline-none focus:border-indigo-500"
              />
              <svg
                class="w-5 h-5 text-gray-400 absolute left-3 top-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </div>

            <!-- Lot Cards List -->
            <div id="lot-list-container" class="space-y-4">
              <!-- Populated via JS -->
            </div>
          </div>
        </section>

        <!-- 3. LOT DETAILS (SLOT GRID) -->
        <section
          id="view-lot-details"
          class="hidden flex flex-col h-full slide-in"
        >
          <div class="bg-white p-4 shadow-sm z-10">
            <h2 id="detail-lot-name" class="text-lg font-bold text-gray-900">
              Lot Name
            </h2>
            <p id="detail-lot-meta" class="text-xs text-gray-500">
              Address • 2.4km
            </p>

            <!-- Legend -->
            <div class="flex space-x-4 text-xs mt-3">
              <div class="flex items-center">
                <span class="w-2 h-2 bg-emerald-500 rounded-full mr-1.5"></span>
                Free
              </div>
              <div class="flex items-center">
                <span class="w-2 h-2 bg-amber-500 rounded-full mr-1.5"></span>
                My Spot
              </div>
              <div class="flex items-center">
                <span class="w-2 h-2 bg-rose-500 rounded-full mr-1.5"></span>
                Busy
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
            <div id="slots-grid" class="grid grid-cols-3 gap-3">
              <!-- Populated via JS -->
            </div>
          </div>
        </section>

        <!-- 4. BOOKING & TIMER SCREEN -->
        <section
          id="view-booking"
          class="hidden h-full flex flex-col slide-in bg-white"
        >
          <div
            class="flex-1 flex flex-col items-center justify-center p-6 text-center"
          >
            <!-- Dynamic Status Ring -->
            <div
              id="timer-ring"
              class="w-64 h-64 rounded-full border-8 border-amber-100 flex flex-col items-center justify-center relative mb-8"
            >
              <div
                class="absolute inset-0 rounded-full border-8 border-amber-500 border-t-transparent animate-spin-slow opacity-50"
              ></div>
              <span
                id="timer-status-text"
                class="text-amber-600 font-bold text-sm tracking-widest uppercase mb-1"
                >Reserved</span
              >
              <span
                id="timer-display"
                class="text-5xl font-mono font-bold text-gray-800"
                >00:00</span
              >
            </div>

            <div class="w-full bg-gray-50 rounded-2xl p-4 mb-6 text-left">
              <div
                class="flex justify-between items-center border-b border-gray-200 pb-3 mb-3"
              >
                <span class="text-gray-500 text-xs uppercase">Vehicle</span>
                <span
                  id="active-booking-vehicle"
                  class="font-bold text-gray-900"
                  >--</span
                >
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500 text-xs uppercase">Location</span>
                <span id="active-booking-slot" class="font-bold text-gray-900"
                  >--</span
                >
              </div>
            </div>

            <!-- Action: Check In -->
            <button
              id="btn-checkin"
              onclick="simulateQRScan()"
              class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                />
              </svg>
              Scan QR at Pillar
            </button>

            <!-- Action: Pay & Exit -->
            <button
              id="btn-pay-exit"
              onclick="calculateBill()"
              class="hidden w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition"
            >
              Stop Timer & Pay
            </button>
          </div>
        </section>

        <!-- 5. PAYMENT SCREEN -->
        <section
          id="view-payment"
          class="hidden h-full flex flex-col p-6 slide-in bg-gray-50"
        >
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Payment Due</h2>
          <div class="bg-white rounded-2xl shadow-sm p-5 mb-6">
            <div class="flex justify-between py-2 border-b border-gray-100">
              <span class="text-gray-500">Parking Fee</span>
              <span id="bill-parking" class="font-medium">₹0.00</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-100">
              <span class="text-gray-500">Reservation</span>
              <span id="bill-reserve" class="font-medium">₹0.00</span>
            </div>
            <div class="flex justify-between py-2 text-rose-500">
              <span>Pending Dues</span>
              <span id="bill-dues">₹0.00</span>
            </div>
            <div class="flex justify-between py-4 mt-2">
              <span class="text-xl font-bold text-gray-800">Total</span>
              <span id="bill-total" class="text-2xl font-bold text-indigo-600"
                >₹0.00</span
              >
            </div>
          </div>
          <button
            onclick="processPayment()"
            class="w-full bg-emerald-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-auto mb-4"
          >
            Pay Securely
          </button>
        </section>

        <!-- 6. PROFILE SCREEN -->
        <section
          id="view-profile"
          class="hidden min-h-full p-4 slide-in bg-gray-50"
        >
          <!-- User Info -->
          <div
            class="bg-white rounded-2xl p-6 shadow-sm mb-4 flex items-center"
          >
            <img
              id="profile-img"
              src=""
              class="w-16 h-16 rounded-full border-2 border-indigo-100 mr-4"
            />
            <div>
              <h2 id="profile-name" class="text-xl font-bold text-gray-900">
                Name
              </h2>
              <p id="profile-email" class="text-sm text-gray-500">email</p>
            </div>
          </div>

          <!-- Outstanding Dues (Conditional) -->
          <div
            id="dues-card"
            class="bg-rose-50 border border-rose-100 rounded-xl p-4 mb-4 hidden"
          >
            <div class="flex justify-between items-center">
              <div>
                <p class="text-rose-700 font-bold text-sm">Outstanding Dues</p>
                <p class="text-rose-600 text-xs">
                  Unpaid penalties from last session.
                </p>
              </div>
              <div class="text-right">
                <p
                  id="profile-dues-amt"
                  class="text-lg font-bold text-rose-800"
                >
                  ₹0
                </p>
                <button
                  onclick="clearDues()"
                  class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg mt-1 shadow hover:bg-rose-700"
                >
                  Pay Now
                </button>
              </div>
            </div>
          </div>

          <!-- Vehicles -->
          <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-gray-800">My Vehicles</h3>
              <button
                onclick="navigate('view-vehicle-add')"
                class="text-indigo-600 text-sm font-semibold"
              >
                + Add
              </button>
            </div>
            <div id="profile-vehicle-list" class="space-y-3">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Share Access -->
          <div class="bg-white rounded-2xl p-4 shadow-sm mb-8">
            <h3 class="font-bold text-gray-800 mb-2">Share Access</h3>
            <p class="text-xs text-gray-500 mb-3">
              Allow friends or family to drive your cars.
            </p>
            <div class="flex gap-2">
              <input
                type="text"
                id="share-input"
                placeholder="Enter email or phone"
                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500"
              />
              <button
                onclick="inviteUser()"
                class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium"
              >
                Invite
              </button>
            </div>
          </div>

          <button
            onclick="logout()"
            class="w-full text-rose-500 font-medium py-3 border border-rose-200 rounded-xl bg-white"
          >
            Sign Out
          </button>
        </section>

        <!-- 7. ADD VEHICLE SCREEN -->
        <section
          id="view-vehicle-add"
          class="hidden min-h-full p-6 slide-in bg-white"
        >
          <h2 class="text-xl font-bold text-gray-900 mb-6">
            Register New Vehicle
          </h2>
          <form onsubmit="handleVehicleAdd(event)" class="space-y-4">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase"
                >License Plate</label
              >
              <input
                type="text"
                id="new-plate"
                class="w-full border-b-2 border-gray-200 py-2 focus:border-black outline-none font-mono text-lg uppercase"
                placeholder="MH 01 AB 1234"
                required
              />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-gray-500 uppercase"
                  >Model</label
                >
                <input
                  type="text"
                  id="new-model"
                  class="w-full border-b-2 border-gray-200 py-2 focus:border-black outline-none"
                  placeholder="Swift, City..."
                  required
                />
              </div>
              <div>
                <label class="text-xs font-bold text-gray-500 uppercase"
                  >Color</label
                >
                <select
                  id="new-color"
                  class="w-full border-b-2 border-gray-200 py-2 focus:border-black outline-none bg-white"
                >
                  <option>White</option>
                  <option>Black</option>
                  <option>Red</option>
                  <option>Silver</option>
                  <option>Blue</option>
                </select>
              </div>
            </div>
            <div class="pt-4">
              <label
                class="text-xs font-bold text-gray-500 uppercase mb-2 block"
                >Vehicle Type</label
              >
              <div class="flex gap-3">
                <label class="flex-1 cursor-pointer">
                  <input
                    type="radio"
                    name="ntype"
                    value="SMALL"
                    class="peer hidden"
                  />
                  <div
                    class="border rounded-xl py-3 text-center text-sm font-medium text-gray-500 peer-checked:border-indigo-600 peer-checked:text-indigo-600 peer-checked:bg-indigo-50 transition"
                  >
                    Bike
                  </div>
                </label>
                <label class="flex-1 cursor-pointer">
                  <input
                    type="radio"
                    name="ntype"
                    value="MEDIUM"
                    class="peer hidden"
                    checked
                  />
                  <div
                    class="border rounded-xl py-3 text-center text-sm font-medium text-gray-500 peer-checked:border-indigo-600 peer-checked:text-indigo-600 peer-checked:bg-indigo-50 transition"
                  >
                    Car
                  </div>
                </label>
                <label class="flex-1 cursor-pointer">
                  <input
                    type="radio"
                    name="ntype"
                    value="LARGE"
                    class="peer hidden"
                  />
                  <div
                    class="border rounded-xl py-3 text-center text-sm font-medium text-gray-500 peer-checked:border-indigo-600 peer-checked:text-indigo-600 peer-checked:bg-indigo-50 transition"
                  >
                    SUV
                  </div>
                </label>
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-black text-white font-bold py-4 rounded-xl mt-8 shadow-lg"
            >
              Save Vehicle
            </button>
          </form>
        </section>
      </main>

      <!-- BOOKING MODAL (Pop-up) -->
      <div
        id="booking-modal"
        class="hidden absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.15)] p-6 z-50 transform transition-transform duration-300"
      >
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900" id="modal-slot-name">
              A-01
            </h3>
            <p class="text-xs text-amber-600 font-medium mt-1">
              First 10 mins reservation is FREE
            </p>
          </div>
          <button
            onclick="toggleModal('booking-modal', false)"
            class="bg-gray-100 p-2 rounded-full"
          >
            <svg
              class="w-5 h-5 text-gray-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div
          class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-6"
        >
          <span class="text-sm text-gray-500">Booking for:</span>
          <span id="modal-veh-plate" class="font-bold text-gray-800">--</span>
        </div>
        <button
          onclick="confirmBooking()"
          class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg"
        >
          Confirm Reservation
        </button>
      </div>

      <!-- TOAST NOTIFICATION -->
      <div
        id="toast"
        class="absolute top-16 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full text-xs font-medium shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-50 flex items-center"
      >
        <svg
          class="w-4 h-4 text-emerald-400 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          />
        </svg>
        <span id="toast-msg">Action Successful</span>
      </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
      // --- DATA & STATE ---
      const state = {
        user: null,
        vehicles: [
          {
            id: 1,
            plate: "MH 02 X 9999",
            model: "Honda City",
            type: "MEDIUM",
            color: "White",
          },
          {
            id: 2,
            plate: "MH 01 AB 1234",
            model: "Creta",
            type: "LARGE",
            color: "Black",
          },
        ],
        selectedVehicleId: 1,
        navStack: [],
        booking: null, // { slotId, startTime, status, lotName }
        dues: 25.0, // Simulated Dues
        lots: [
          {
            id: 1,
            name: "City Center Mall",
            address: "M.G Road",
            distance: "0.8 km",
            rate: 50,
            slots: 80,
            free: 12,
          },
          {
            id: 2,
            name: "Railway Station",
            address: "Platform 1",
            distance: "2.1 km",
            rate: 30,
            slots: 150,
            free: 0,
          },
          {
            id: 3,
            name: "Tech Park Plaza",
            address: "Sector 5",
            distance: "5.4 km",
            rate: 60,
            slots: 45,
            free: 20,
          },
        ],
        currentSlots: [], // Loaded when clicking a lot
      };

      // --- NAVIGATION SYSTEM ---
      function navigate(targetView) {
        const currentView = document.querySelector("section:not(.hidden)").id;

        // Push to stack unless it's a replacement (like Auth -> Home)
        if (
          currentView !== "view-auth" &&
          targetView !== "view-auth" &&
          currentView !== targetView
        ) {
          state.navStack.push(currentView);
        }

        // Hide all, Show Target
        document
          .querySelectorAll("section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(targetView).classList.remove("hidden");

        updateHeader(targetView);
        window.scrollTo(0, 0);
      }

      function goBack() {
        if (state.navStack.length === 0) return;
        const prevView = state.navStack.pop();

        document
          .querySelectorAll("section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(prevView).classList.remove("hidden");

        updateHeader(prevView);
      }

      function updateHeader(viewId) {
        const header = document.getElementById("app-header");
        const btnBack = document.getElementById("btn-back");
        const logo = document.getElementById("header-logo");
        const vehSelect = document.getElementById("header-vehicle-select");

        if (viewId === "view-auth") {
          header.classList.add("hidden");
          return;
        } else {
          header.classList.remove("hidden");
        }

        if (viewId === "view-home") {
          btnBack.classList.add("hidden");
          logo.classList.remove("hidden");
          vehSelect.classList.remove("hidden");
          state.navStack = []; // Clear stack on home
          renderVehicleSelect();
        } else {
          btnBack.classList.remove("hidden");
          logo.classList.add("hidden");
          vehSelect.classList.add("hidden");
        }
      }

      // --- AUTH ---
      function handleAuth(method, e) {
        if (e) e.preventDefault();
        // Mock Login
        state.user = {
          name: "Rahul Sharma",
          email: "rahul@example.com",
          avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Rahul",
        };

        // Setup Profile
        document.getElementById("profile-name").innerText = state.user.name;
        document.getElementById("profile-email").innerText = state.user.email;
        document.getElementById("header-avatar").src = state.user.avatar;
        document.getElementById("profile-img").src = state.user.avatar;

        renderLotList();
        renderProfileVehicles();
        checkDues();
        navigate("view-home");
      }

      function logout() {
        state.user = null;
        state.navStack = [];
        document.getElementById("app-header").classList.add("hidden");
        document
          .querySelectorAll("section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById("view-auth").classList.remove("hidden");
      }

      // --- HOME & VEHICLES ---
      function renderVehicleSelect() {
        const select = document.getElementById("global-vehicle-select");
        select.innerHTML = "";
        state.vehicles.forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.text = `${v.model} (${v.plate})`;
          if (v.id == state.selectedVehicleId) opt.selected = true;
          select.appendChild(opt);
        });
      }

      function switchVehicle(id) {
        state.selectedVehicleId = id;
        showToast(
          `Switched to ${state.vehicles.find((v) => v.id == id).model}`
        );
      }

      function renderLotList() {
        const container = document.getElementById("lot-list-container");
        container.innerHTML = "";

        state.lots.forEach((lot) => {
          // Status Color
          let statusColor = "text-emerald-600 bg-emerald-50";
          let statusText = `${lot.free} slots free`;
          if (lot.free === 0) {
            statusColor = "text-rose-600 bg-rose-50";
            statusText = "FULL";
          } else if (lot.free < 5) {
            statusColor = "text-amber-600 bg-amber-50";
            statusText = "Filling Fast";
          }

          const html = `
                <div onclick="openLotDetails(${lot.id})" class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm active:scale-95 transition-transform cursor-pointer">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">${lot.name}</h3>
                            <p class="text-xs text-gray-400 flex items-center mt-1">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                ${lot.address} • ${lot.distance}
                            </p>
                        </div>
                        <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold">₹${lot.rate}/hr</div>
                    </div>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-50">
                         <span class="text-xs font-semibold ${statusColor} px-2 py-1 rounded">${statusText}</span>
                         <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </div>
                </div>`;
          container.innerHTML += html;
        });
      }

      // --- SLOT DETAILS ---
      function openLotDetails(lotId) {
        const lot = state.lots.find((l) => l.id === lotId);
        document.getElementById("detail-lot-name").innerText = lot.name;
        document.getElementById(
          "detail-lot-meta"
        ).innerText = `${lot.address} • ${lot.distance}`;

        // Generate Dummy Slots
        const grid = document.getElementById("slots-grid");
        grid.innerHTML = "";

        // Generate 15 dummy slots
        for (let i = 1; i <= 15; i++) {
          const isOccupied = Math.random() < 0.3; // 30% occupied
          const slotName = `A-${i < 10 ? "0" + i : i}`;

          const btn = document.createElement("div");
          btn.className = `aspect-square rounded-xl flex flex-col items-center justify-center border-2 font-bold transition shadow-sm ${
            isOccupied
              ? "border-rose-100 bg-rose-50 text-rose-300 cursor-not-allowed"
              : "border-emerald-100 bg-white text-emerald-600 hover:border-emerald-500 cursor-pointer"
          }`;
          btn.innerHTML = `<span class="text-lg">${slotName}</span>`;

          if (!isOccupied) {
            btn.onclick = () => openBookingModal(slotName, lot.name);
          }

          grid.appendChild(btn);
        }

        navigate("view-lot-details");
      }

      // --- BOOKING LOGIC ---
      function openBookingModal(slotName, lotName) {
        const vehicle = state.vehicles.find(
          (v) => v.id == state.selectedVehicleId
        );
        document.getElementById("modal-slot-name").innerText = slotName;
        document.getElementById("modal-veh-plate").innerText = vehicle.plate;

        state.tempBooking = { slot: slotName, lot: lotName };
        toggleModal("booking-modal", true);
      }

      function toggleModal(id, show) {
        const el = document.getElementById(id);
        if (show) {
          el.classList.remove("hidden");
          el.classList.add("translate-y-0");
        } else {
          el.classList.add("hidden");
        }
      }

      function confirmBooking() {
        toggleModal("booking-modal", false);

        state.booking = {
          active: true,
          startTime: new Date(),
          slot: state.tempBooking.slot,
          lot: state.tempBooking.lot,
          status: "RESERVED",
        };

        // Update Booking UI
        document.getElementById(
          "active-booking-slot"
        ).innerText = `${state.booking.lot}, ${state.booking.slot}`;
        document.getElementById("active-booking-vehicle").innerText =
          state.vehicles.find((v) => v.id == state.selectedVehicleId).plate;

        document.getElementById("timer-status-text").innerText = "RESERVED";
        document.getElementById("timer-ring").className =
          "w-64 h-64 rounded-full border-8 border-amber-100 flex flex-col items-center justify-center relative mb-8";

        document.getElementById("btn-checkin").classList.remove("hidden");
        document.getElementById("btn-pay-exit").classList.add("hidden");

        startTimer();
        navigate("view-booking");
      }

      let timerInterval;
      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const now = new Date();
          const diff = Math.floor((now - state.booking.startTime) / 1000);
          const mins = Math.floor(diff / 60)
            .toString()
            .padStart(2, "0");
          const secs = (diff % 60).toString().padStart(2, "0");
          document.getElementById(
            "timer-display"
          ).innerText = `${mins}:${secs}`;
        }, 1000);
      }

      function simulateQRScan() {
        state.booking.status = "PARKED";
        document.getElementById("timer-status-text").innerText = "ACTIVE";
        document.getElementById("timer-status-text").className =
          "text-emerald-600 font-bold text-sm tracking-widest uppercase mb-1";

        // Change Ring Color
        document.getElementById("timer-ring").className =
          "w-64 h-64 rounded-full border-8 border-emerald-100 flex flex-col items-center justify-center relative mb-8";

        document.getElementById("btn-checkin").classList.add("hidden");
        document.getElementById("btn-pay-exit").classList.remove("hidden");

        showToast("QR Verified. Timer Running.");
      }

      function calculateBill() {
        clearInterval(timerInterval);
        // Sim logic
        document.getElementById("bill-parking").innerText = "₹50.00";
        document.getElementById("bill-reserve").innerText = "₹0.00 (Waived)";
        document.getElementById("bill-dues").innerText = `₹${state.dues.toFixed(
          2
        )}`;
        const total = 50 + state.dues;
        document.getElementById("bill-total").innerText = `₹${total.toFixed(
          2
        )}`;

        navigate("view-payment");
      }

      function processPayment() {
        showToast("Processing Payment...");
        setTimeout(() => {
          state.booking = null;
          state.dues = 0;
          showToast("Payment Success! Gate Open.");
          navigate("view-home");
        }, 1500);
      }

      // --- PROFILE & EXTRAS ---
      function handleVehicleAdd(e) {
        e.preventDefault();
        const plate = document.getElementById("new-plate").value;
        const model = document.getElementById("new-model").value;
        const color = document.getElementById("new-color").value;

        state.vehicles.push({
          id: Date.now(),
          plate,
          model,
          color,
          type: "MEDIUM",
        });

        renderVehicleSelect();
        renderProfileVehicles();
        goBack();
        showToast("Vehicle Added Successfully");
      }

      function renderProfileVehicles() {
        const list = document.getElementById("profile-vehicle-list");
        list.innerHTML = "";
        state.vehicles.forEach((v) => {
          list.innerHTML += `
                <div class="flex justify-between items-center border-b border-gray-50 py-2">
                    <div>
                        <p class="font-bold text-sm">${v.model}</p>
                        <p class="text-xs text-gray-500">${v.plate} • ${v.color}</p>
                    </div>
                </div>`;
        });
      }

      function inviteUser() {
        const val = document.getElementById("share-input").value;
        if (val) {
          document.getElementById("share-input").value = "";
          showToast(`Invite sent to ${val}`);
        }
      }

      function checkDues() {
        const el = document.getElementById("dues-card");
        if (state.dues > 0) {
          el.classList.remove("hidden");
          document.getElementById(
            "profile-dues-amt"
          ).innerText = `₹${state.dues}`;
        } else {
          el.classList.add("hidden");
        }
      }

      function clearDues() {
        showToast("Payment Processing...");
        setTimeout(() => {
          state.dues = 0;
          checkDues();
          showToast("Dues Cleared!");
        }, 1000);
      }

      // --- UTILS ---
      function showToast(msg) {
        const toast = document.getElementById("toast");
        document.getElementById("toast-msg").innerText = msg;
        toast.classList.remove("opacity-0", "translate-y-4");
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-y-4");
        }, 3000);
      }

      // Initialize
      updateHeader("view-auth");
    </script>
  </body>
</html>
